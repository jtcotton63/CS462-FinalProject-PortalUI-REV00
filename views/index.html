<!DOCTYPE html>
<html>
    <head>
        <title>Home</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <!-- Imports -->
        <script src="https://code.jquery.com/jquery-3.2.1.js"></script>
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular-cookies.js"></script>
        <script src="https://rawgit.com/dwmkerr/angular-modal-service/master/dst/angular-modal-service.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        
                
        <!-- Scripts -->
        <script>
            var app = angular.module('IndexApp',['ngCookies', 'angularModalService']);

    
    
            app.controller('IndexCtrl', ['$scope', '$http', '$cookies', 'ModalService', function($scope, $http, $cookies, ModalService) {
                    $scope.urlUserSvc = 'http://localhost:8080/services/user';
                    $scope.urlJobSvc = 'http://localhost:8080/services/job';
                    
                    $scope.user = null;
                    $scope.getUserDetails = function() {
                        var userIdString = $cookies.get('userId');
                        var userId = parseInt(userIdString);
                        $http({
                            method: 'GET',
                            url: $scope.urlUserSvc + '/users/' +  userId
                        }).then(
                                function success(response) {
                                    console.log('User data received');
                                    console.log(response.data);
                                    return response.data;
                                }
                        );
                    };
                    
                    $scope.title = 'Current Jobs';
                    
                    $scope.jobs = null;
                    $scope.displayIndex = null;
                    $scope.isDisplayLeftArrow = null;
                    $scope.isDisplayRightArrow = null;
                    $scope.contentSize = 2000;
                    $scope.getJobs = function(index) {
                        var pageIndex = index + 1;
                        $http({
                            method: 'GET',
                            url: $scope.urlJobSvc + '/jobs?page=' +  pageIndex + '&size=' + $scope.contentSize
                        }).then(
                                function success(response) {
                                    console.log('Job data received page ' + pageIndex + ' size ' + $scope.contentSize);
                                    var data = response.data;
                                    console.log(data);
                                    
                                    $scope.jobs = data.content;
                                    var tempDisplayNumber = data.number + 1;
                                    $scope.displayIndex = tempDisplayNumber;
                                    $scope.isDisplayLeftArrow = !data.first;
                                    $scope.isDisplayRightArrow = !data.last;
                                }
                        );
                    };
                    
                    $scope.edit = function(job) {
                        ModalService.showModal({
                            templateUrl: 'edit_modal.html',
                            controller: "EditModalController",
                            inputs: {
                                job: job
                            }
                        }).then(function(modal) {
                            modal.element.modal();
                            modal.close.then(function(result) {
                                console.log(result);
                            });
                        });
                    };
                    
                    angular.element(document).ready(function () {
                        $scope.user = $scope.getUserDetails();
                        $scope.getJobs(0);
                    });
            }]);
        
        
        
            app.controller('EditModalController', ['$scope', 'job', 'close', function($scope, job, close) {
                    $scope.job = job;
                    console.log($scope.job);
                    $scope.close = function(result) {
                        close(result, 500);
                    };
            }]);
        
        
        
        </script>
        
        
        
        <!-- Style -->
        <style>
            body { 
                padding: 40px;
            }
            
            h1 {
                padding-bottom: 25px;
            }
        </style>
        
        
        
    </head>
    <body ng-app="IndexApp" class="container">
        
        <nav class="navbar navbar-primary">
            <div class="container-fluid">
                <div class="nav navbar-nav">
                    <li><a href="/">Jobs</a></li>
                    <li><a href="/helpers">Helpers</a></li>
                </div>
            </div>
        </nav>
        
        <div ng-controller="IndexCtrl" class="jumbotron">
            <div class="text-center">
                <h1>{{title}}</h1>
            </div>
            
            <table class="table table-bordered table-striped">
                <thead class="thead-inverse">
                    <tr>
                        <th>ID</th>
                        <th>Address</th>
                        <th>Description</th>
                        <th>Job Time</th>
                        <th>Rendezvous Time</th>
                        <th>Accepted By</th>
                        <th>Edit</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                
                <tbody>
                    
                    <tr ng-repeat="job in jobs">
                        <td>{{job.id}}</td>
                        <td>{{job.address}}</td>
                        <td>{{job.description}}</td>
                        <td>{{job.jobTime | date: 'd MMM @ h:m a'}}</td>
                        <td>{{job.rendevousTime | date: 'd MMM @ h:m a'}}</td>
                        <td>{{job.acceptedBy || "None"}}</td>
                        <td class="text-center"><p><button class="btn btn-primary btn-xs" data-title="Edit" data-toggle="modal" ng-click="edit(job)"><span class="glyphicon glyphicon-pencil"></span></button></p></td>
                        <td class="text-center"><p><button class="btn btn-danger btn-xs" data-title="Delete" data-toggle="modal" data-target="#delete"><span class="glyphicon glyphicon-trash"></span></button></p></td>
                    </tr>
                    
                </tbody>
                
            </table>
        </div>
        
        
        
        <!-- Edit Job Modal -->
        <script type="text/ng-template" id="edit_modal.html">
            <div class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" ng-click="close('Cancel')" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">Yes or No?</h4>
                        </div>
                        <div class="modal-body">
                            <p>{{job.address}}</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" ng-click="close('Yes')" class="btn btn-primary" data-dismiss="modal">Yes</button>
                        </div>
                    </div>
                </div>
            </div>
        </script>
        
        
        
    </body>
    
</html>
